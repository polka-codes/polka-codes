name: Issue Handler

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

env:
  POLKA_API_PROVIDER: openrouter
  POLKA_MODEL: deepseek/deepseek-chat
  POLKA_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  GH_TOKEN: ${{ github.token }}

jobs:
  handle:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'polka.codes')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get issue content
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.eventName === 'workflow_dispatch' 
              ? context.payload.inputs.issue_number 
              : context.issue.number;

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            })

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            })

            // Format the issue data
            const formattedIssue = {
              number: issue.number,
              title: issue.title,
              body: issue.body,
              author: issue.user.login,
              created_at: issue.created_at,
              comments: comments.map(c => ({
                author: c.user.login,
                body: c.body,
                created_at: c.created_at
              }))
            }

            return formattedIssue

      - name: Format task
        id: format
        run: |
          # Create a formatted task string with proper structure
          TASK=$(cat << EOF
          Issue #${{ fromJson(steps.issue.outputs.result).number }}: ${{ fromJson(steps.issue.outputs.result).title }}
          Author: @${{ fromJson(steps.issue.outputs.result).author }}
          Created: ${{ fromJson(steps.issue.outputs.result).created_at }}

          ${{ fromJson(steps.issue.outputs.result).body }}

          Comments:
          $(for comment in $(echo '${{ toJson(fromJson(steps.issue.outputs.result).comments) }}' | jq -c '.[]'); do
            author=$(echo $comment | jq -r '.author')
            created_at=$(echo $comment | jq -r '.created_at')
            body=$(echo $comment | jq -r '.body')
            echo -e "@$author at $created_at:\n$body\n"
          done)
          EOF
          )

          # Escape the task string for GitHub Actions
          TASK="${TASK//'%'/'%25'}"
          TASK="${TASK//$'\n'/'%0A'}"
          TASK="${TASK//$'\r'/'%0D'}"

          echo "TASK=$TASK" >> $GITHUB_OUTPUT

      - name: Run polka.codes CLI
        run: |
          echo "${{ steps.format.outputs.TASK }}"
          echo "${{ steps.format.outputs.TASK }}" | bun cli

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b polka-codes/issue-${{ github.event.issue.number }}
          bun cli commit -a
          bun cli pr

# Generated by polka.codes
