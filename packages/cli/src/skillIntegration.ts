/**
 * Skill integration utilities
 *
 * Provides functionality to integrate Agent Skills with the agent workflow:
 * - Generate system prompts with skill metadata
 * - Create skill context for agent execution
 * - Manage skill loading during agent operations
 *
 * Generated by polka.codes
 */

import type { Skill, SkillContext } from '@polka-codes/core'
import { SkillDiscoveryService } from '@polka-codes/core'

/**
 * Generate a system prompt section describing available skills
 */
export function generateSkillsSystemPrompt(skills: Skill[]): string {
  if (skills.length === 0) {
    return ''
  }

  let prompt = '\n## Available Skills\n\n'
  prompt += 'You have access to the following Agent Skills that provide specialized capabilities:\n\n'

  for (const skill of skills) {
    const sourceLabel = skill.source === 'project' ? 'ðŸ“ Project' : skill.source === 'personal' ? 'ðŸ  Personal' : 'ðŸ”Œ Plugin'
    prompt += `### ${skill.metadata.name}\n`
    prompt += `${sourceLabel} - ${skill.metadata.description}\n\n`

    if (skill.metadata.allowedTools && skill.metadata.allowedTools.length > 0) {
      prompt += `**Allowed Tools:** ${skill.metadata.allowedTools.join(', ')}\n\n`
    }
  }

  prompt += `**Using Skills:**
- Use the \`loadSkill\` tool to access a skill's detailed instructions and supporting files
- When a skill is loaded, follow its instructions carefully to complete specialized tasks
- Skills provide domain-specific guidance for tasks like testing, deployment, or framework-specific operations
- Use the \`listSkills\` tool to discover available skills matching your current task

`

  return prompt
}

/**
 * Create an initial skill context for agent execution
 */
export async function createSkillContext(cwd?: string): Promise<SkillContext> {
  const service = new SkillDiscoveryService({ cwd: cwd || process.cwd() })
  return await service.createContext()
}

/**
 * Get skill tools for agent workflow
 */
export function getSkillTools() {
  return [
    {
      name: 'loadSkill',
      description: 'Load an Agent Skill to access its detailed instructions and capabilities',
      parameters: {
        skillName: {
          type: 'string',
          description: 'Name of the skill to load',
          required: true,
        },
      },
      handler: async (input: { skillName: string }, context: any) => {
        const { loadSkill } = await import('@polka-codes/core')
        return await loadSkill(input, context.skillContext)
      },
    },
    {
      name: 'listSkills',
      description: 'List all available Agent Skills with optional filtering',
      parameters: {
        filter: {
          type: 'string',
          description: 'Optional filter string to search skills by name or description',
          required: false,
        },
      },
      handler: async (input: { filter?: string }, context: any) => {
        const { listSkills } = await import('@polka-codes/core')
        return await listSkills(input, context.skillContext)
      },
    },
  ]
}
