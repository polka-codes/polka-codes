/**
 * Skill integration utilities
 *
 * Provides functionality to integrate Agent Skills with the agent workflow:
 * - Generate system prompts with skill metadata
 * - Create skill context for agent execution
 * - Manage skill loading during agent operations
 *
 * Generated by polka.codes
 */

import type { Skill, SkillContext } from '@polka-codes/core'
import { SkillDiscoveryService, SOURCE_ICONS } from '@polka-codes/core'

/**
 * Generate a system prompt section describing available skills
 */
export function generateSkillsSystemPrompt(skills: Skill[]): string {
  if (skills.length === 0) {
    return ''
  }

  let prompt = '\n## Available Skills\n\n'
  prompt += 'You have access to the following Agent Skills that provide specialized capabilities:\n\n'

  for (const skill of skills) {
    const icon = SOURCE_ICONS[skill.source]
    const sourceLabel = `${icon} ${skill.source.charAt(0).toUpperCase() + skill.source.slice(1)}`
    prompt += `### ${skill.metadata.name}\n`
    prompt += `${sourceLabel} - ${skill.metadata.description}\n\n`

    if (skill.metadata.allowedTools && skill.metadata.allowedTools.length > 0) {
      prompt += `**Allowed Tools:** ${skill.metadata.allowedTools.join(', ')}\n\n`
    }
  }

  prompt += `**Using Skills:**
- Use the \`loadSkill\` tool to access a skill's detailed instructions and supporting files
- When a skill is loaded, follow its instructions carefully to complete specialized tasks
- Skills provide domain-specific guidance for tasks like testing, deployment, or framework-specific operations
- Use the \`listSkills\` tool to discover available skills matching your current task

`

  return prompt
}

/**
 * Create an initial skill context for agent execution
 */
export async function createSkillContext(cwd?: string): Promise<SkillContext> {
  const service = new SkillDiscoveryService({ cwd: cwd || process.cwd() })
  return await service.createContext()
}
