// generated by polka.codes

import type { PlainJson, Workflow } from '@polka-codes/workflow'
import type { CliToolRegistry } from '../workflow-tools'
import { fixWorkflow } from './fix.workflow'
import { getImplementPrompt } from './prompts'
import { runSubWorkflow } from './runSubWorkflow'
import { createPlan } from './utils/createPlan'

export type JsonImagePart = {
  type: 'image'
  mediaType: string
  image: string // base64 encoded
}

export type JsonFilePart = {
  type: 'file'
  mediaType: string
  filename: string
  data: string // base64 encoded
}

export type CodeWorkflowInput = {
  task: string
  checkCommand?: string
  files?: (JsonFilePart | JsonImagePart)[]
}

export const codeWorkflow: Workflow<CodeWorkflowInput, PlainJson, CliToolRegistry> = {
  name: 'Code Task',
  description: 'Plan and implement a feature or task using architect and coder agents.',
  async *fn(input, _step, tools) {
    const { task, files, checkCommand } = input
    let plan = ''
    let userFeedback = ''
    let implementationComplete = false

    // Planning phase
    while (true) {
      console.log('\n📋 Phase 1: Creating implementation plan...\n')
      plan = yield* createPlan({
        tools,
        task,
        userFeedback,
        files,
      })

      console.log('\n📋 Generated Implementation Plan:\n')
      console.log(plan)
      console.log('\n')

      const approved = yield* tools.confirm({
        message: 'Do you approve this plan and want to proceed with implementation?',
        default: false,
      })

      if (approved) {
        userFeedback = ''
        break
      } else {
        userFeedback = yield* tools.input({
          message: 'What changes would you like to make to the plan?',
        })
      }
    }

    // Implementation phase
    console.log('\n⚙️  Phase 2: Implementing the plan...\n')

    const implementPrompt = getImplementPrompt(plan)

    const coderMessages: any[] = [{ type: 'user', content: implementPrompt }]
    if (files) {
      coderMessages[0].content = [
        implementPrompt,
        ...files.map((f) => ({
          ...f,
          image: f.type === 'image' ? Buffer.from(f.image, 'base64') : undefined,
          data: f.type === 'file' ? Buffer.from(f.data, 'base64') : undefined,
        })),
      ]
    }

    yield* tools.invokeAgent({
      agent: 'coder',
      messages: coderMessages,
      defaultContext: true,
    })

    implementationComplete = true
    console.log('\n✅ Implementation complete!\n')

    // Fixing phase
    if (checkCommand) {
      console.log('\n🔧 Phase 3: Checking for errors...\n')
      yield* runSubWorkflow(tools, fixWorkflow, { command: checkCommand, interactive: false })
    } else {
      console.log('\n✅ Skipping checks.')
    }

    return {
      success: implementationComplete,
      plan,
    }
  },
}
