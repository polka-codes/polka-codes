// generated by polka.codes
import { type Config, loadConfigAtPath } from '@polka-codes/cli-shared'
import { agentWorkflow, listFiles, readFile, searchFiles, type WorkflowFn } from '@polka-codes/core'
import { parse, stringify } from 'yaml'
import { z } from 'zod'
import type { CliToolRegistry } from '../workflow-tools'
import { INIT_WORKFLOW_ANALYZE_SYSTEM_PROMPT } from './prompts'
import type { BaseWorkflowInput } from './workflow.utils'

export type InitWorkflowInput = {
  configPath: string
}

type InitWorkflowOutput = {
  configPath: string
}

export const initWorkflow: WorkflowFn<InitWorkflowInput & BaseWorkflowInput, InitWorkflowOutput, CliToolRegistry> = async (
  input,
  context,
) => {
  const { step, logger, tools } = context
  const { configPath } = input

  const result = await step('analyze-project', async () => {
    logger.info('Analyzing project files...')

    return await agentWorkflow(
      {
        systemPrompt: INIT_WORKFLOW_ANALYZE_SYSTEM_PROMPT,
        userMessage: [
          {
            role: 'user',
            content: 'Please provide a valid polkacodes YAML configuration for the project.',
          },
        ],
        tools: [readFile, listFiles, searchFiles],
        outputSchema: z.object({ yaml: z.string() }),
      },
      { logger, tools, step },
    )
  })

  let generatedConfig: any = {}
  if (result.type === 'Exit' && result.object) {
    const yamlConfig = result.object.yaml
    generatedConfig = yamlConfig ? parse(yamlConfig) : {}
  }

  await step('save-config', async () => {
    const existingConfig = loadConfigAtPath(configPath) ?? {}

    const finalConfig: Config = {
      ...existingConfig,
      ...generatedConfig,
    }

    await tools.writeToFile({ path: configPath, content: stringify(finalConfig) })
    logger.info(`Configuration updated with analysis results at ${configPath}`)
  })

  return { configPath }
}
