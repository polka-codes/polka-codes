// generated by polka.codes

import { createErrorClass } from '@polka-codes/core'

/**
 * Error thrown when user cancels an operation
 */
export const UserCancelledError = createErrorClass('UserCancelledError', (args: [string?] = []) => args[0] ?? 'User cancelled')

/**
 * Base class for AI provider errors
 */
export abstract class ProviderError extends Error {
  public readonly provider: string
  public readonly model: string
  public readonly retryable: boolean
  public readonly cause?: Error

  constructor(provider: string, model: string, message: string, retryable: boolean, cause?: Error) {
    super(message)
    this.name = this.constructor.name
    this.provider = provider
    this.model = model
    this.retryable = retryable
    this.cause = cause
  }
}

/**
 * Error when the provider API is temporarily unavailable (5xx errors)
 */
export class ProviderUnavailableError extends ProviderError {
  constructor(provider: string, model: string, statusCode: number, cause?: Error) {
    super(
      provider,
      model,
      `${provider} API is temporarily unavailable (HTTP ${statusCode}). The service may be experiencing issues. Please try again in a few minutes.`,
      true,
      cause,
    )
  }
}

/**
 * Error when rate limit is exceeded (429 errors)
 */
export class RateLimitError extends ProviderError {
  public readonly retryAfter?: number

  constructor(provider: string, model: string, retryAfter?: number, cause?: Error) {
    const message = retryAfter
      ? `${provider} rate limit exceeded. Please retry after ${retryAfter} seconds.`
      : `${provider} rate limit exceeded. Please wait a few minutes before retrying.`
    super(provider, model, message, true, cause)
    this.retryAfter = retryAfter
  }
}

/**
 * Error when request times out
 */
export class ProviderTimeoutError extends ProviderError {
  public readonly timeoutSeconds: number

  constructor(provider: string, model: string, timeoutSeconds: number, cause?: Error) {
    super(
      provider,
      model,
      `${provider} request timed out after ${timeoutSeconds} seconds. This could be due to network issues or the service being slow. Please check your connection and try again.`,
      true,
      cause,
    )
    this.timeoutSeconds = timeoutSeconds
  }
}

/**
 * Error when authentication fails (401 errors)
 */
export class AuthenticationError extends ProviderError {
  constructor(provider: string, model: string, cause?: Error) {
    super(
      provider,
      model,
      `${provider} authentication failed for model '${model}'. Please check your API key is valid and has not expired. Run 'polka init' to reconfigure.`,
      false,
      cause,
    )
  }
}

/**
 * Error when the model is not found or access is denied (403/404 errors)
 */
export class ModelAccessError extends ProviderError {
  constructor(provider: string, model: string, statusCode: number, cause?: Error) {
    super(
      provider,
      model,
      `${provider} model '${model}' is not available (HTTP ${statusCode}). This could mean the model doesn't exist, you don't have access, or it's not enabled in your account. Please check your model configuration.`,
      false,
      cause,
    )
  }
}

/**
 * Error when the request is invalid (400 errors)
 */
export class InvalidRequestError extends ProviderError {
  constructor(provider: string, model: string, details: string, cause?: Error) {
    super(
      provider,
      model,
      `${provider} rejected the request: ${details}. Please check your request parameters and try again.`,
      false,
      cause,
    )
  }
}

/**
 * Error when provider response is malformed or cannot be parsed
 */
export class MalformedResponseError extends ProviderError {
  constructor(provider: string, model: string, cause?: Error) {
    super(
      provider,
      model,
      `${provider} returned an invalid response for model '${model}'. This could indicate a provider issue or incompatible API version. Please try again or contact support.`,
      true,
      cause,
    )
  }
}

/**
 * Error when quota/budget limits are exceeded
 */
export class QuotaExceededError extends ProviderError {
  public readonly currentCost: number
  public readonly maxCost: number

  constructor(provider: string, model: string, currentCost: number, maxCost: number) {
    super(
      provider,
      model,
      `${provider} quota exceeded for model '${model}'. Current cost: $${currentCost.toFixed(2)}, Max budget: $${maxCost.toFixed(2)}. Adjust your budget with 'polka init' or reduce usage.`,
      false,
    )
    this.currentCost = currentCost
    this.maxCost = maxCost
  }
}

/**
 * Error when provider is repeatedly failing after multiple retries
 */
export class MaxRetriesExceededError extends ProviderError {
  public readonly attempts: number
  public readonly lastError: Error

  constructor(provider: string, model: string, attempts: number, lastError: Error) {
    super(
      provider,
      model,
      `${provider} failed after ${attempts} retry attempts for model '${model}'. Last error: ${lastError.message}. Please check your network connection and verify the service is operational.`,
      false,
      lastError,
    )
    this.attempts = attempts
    this.lastError = lastError
  }
}

/**
 * Utility function to create appropriate error based on HTTP status code
 */
export function createProviderErrorFromStatus(provider: string, model: string, statusCode: number, cause?: Error): ProviderError {
  switch (statusCode) {
    case 400:
      return new InvalidRequestError(provider, model, 'Bad request', cause)
    case 401:
      return new AuthenticationError(provider, model, cause)
    case 403:
    case 404:
      return new ModelAccessError(provider, model, statusCode, cause)
    case 429:
      return new RateLimitError(provider, model, undefined, cause)
    default:
      if (statusCode >= 500) {
        return new ProviderUnavailableError(provider, model, statusCode, cause)
      }
      return new InvalidRequestError(provider, model, `HTTP ${statusCode}`, cause)
  }
}
