// Generated by polka.codes

/**
 * Test to verify error classes preserve stack traces correctly
 */

import { describe, expect, test } from 'bun:test'
import { CommandExecutionError, FileSystemAccessError, JSONParseError, safeJSONParse } from '../error-handling.js'

describe('Error Handling', () => {
  describe('FileSystemAccessError', () => {
    test('should create error with path and operation', () => {
      const error = new FileSystemAccessError('/test/path.txt', 'read')

      expect(error.name).toBe('FileSystemAccessError')
      expect(error.message).toContain('/test/path.txt')
      expect(error.message).toContain('read')
      expect(error.stack).toContain('FileSystemAccessError')
      expect(error instanceof FileSystemAccessError).toBe(true)
    })
  })

  describe('CommandExecutionError', () => {
    test('should create error with command, exit code, and stderr', () => {
      const error = new CommandExecutionError('npm install', 1, 'Error: package not found')

      expect(error.name).toBe('CommandExecutionError')
      expect(error.message).toContain('npm install')
      expect(error.message).toContain('code 1')
      expect(error.stack).toContain('CommandExecutionError')
      expect(error instanceof CommandExecutionError).toBe(true)
    })
  })

  describe('JSONParseError', () => {
    test('should create error with file path and content', () => {
      const content = '{invalid json'
      const originalError = new Error('Unexpected token')
      const error = new JSONParseError('/test/config.json', content, originalError)

      expect(error.name).toBe('JSONParseError')
      expect(error.message).toContain('/test/config.json')
      expect(error.cause).toBe(originalError)
      expect(error.stack).toContain('JSONParseError')
      expect(error instanceof JSONParseError).toBe(true)
    })
  })

  describe('safeJSONParse', () => {
    test('should include file path in error', () => {
      const content = '{invalid json'

      expect(() => safeJSONParse(content, '/config/test.json')).toThrow(JSONParseError)
      expect(() => safeJSONParse(content, '/config/test.json')).toThrow(
        expect.objectContaining({
          message: expect.stringContaining('/config/test.json'),
          cause: expect.any(Error),
        }),
      )
    })

    test('should include raw content in error', () => {
      const content = '{invalid json'

      expect(() => safeJSONParse(content, '/test.json')).toThrow(JSONParseError)
      expect(() => safeJSONParse(content, '/test.json')).toThrow(
        expect.objectContaining({
          cause: expect.any(Error),
        }),
      )
    })
  })
})
