// generated by polka.codes

import type { ToolSet } from 'ai'
import { z } from 'zod'
import type { McpManager } from './manager'

/**
 * Validate and convert MCP input schema to Zod schema
 *
 * This function handles the type conversion between MCP tool schemas (which can be
 * JSON Schema or Zod schemas) and the AI SDK's expected Zod schema format.
 *
 * The conversion is necessary because:
 * 1. MCP tools can have either JSON Schema or Zod schemas as inputSchema
 * 2. AI SDK expects Zod schemas for tool validation
 * 3. We need to ensure type safety while handling both formats
 *
 * @param schema - The MCP tool input schema (JSON Schema, Zod schema, or Record)
 * @returns A Zod schema compatible with AI SDK
 */
export function adaptMcpSchemaToZod(schema: unknown): z.ZodTypeAny {
  // If it's already a Zod schema (has safeParse method), return it directly
  if (typeof schema === 'object' && schema !== null && 'safeParse' in schema && typeof schema.safeParse === 'function') {
    return schema as z.ZodTypeAny
  }

  // If it's a plain JSON Schema object or Record, wrap it in a dynamic schema
  // This allows the MCP server to handle validation
  if (typeof schema === 'object' && schema !== null) {
    // Create a Zod schema that accepts any object and passes validation through
    // The actual validation will be done by the MCP server
    return z.record(z.string(), z.any()).or(z.object({}).passthrough())
  }

  // Fallback: accept any input and let MCP server validate
  return z.any()
}

/**
 * Create AI SDK tools from MCP server connections
 */
export function createMcpTools(mcpManager: McpManager): ToolSet {
  const tools: ToolSet = {}

  const allMcpTools = mcpManager.getAllTools()

  for (const [fullToolName, { tool }] of allMcpTools) {
    tools[fullToolName] = {
      description: tool.description || `MCP tool: ${tool.name}`,
      inputSchema: adaptMcpSchemaToZod(tool.inputSchema),
      execute: async (args: Record<string, unknown>) => {
        return await mcpManager.callTool(fullToolName, args)
      },
    }
  }

  return tools
}

/**
 * Get list of MCP tool names for a given server
 */
export function getMcpToolNames(mcpManager: McpManager, serverName?: string): string[] {
  if (serverName) {
    const serverTools = mcpManager.getServerTools(serverName)
    return Array.from(serverTools.keys())
  }

  const allTools = mcpManager.getAllTools()
  return Array.from(allTools.keys())
}
