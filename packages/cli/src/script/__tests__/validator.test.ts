// generated by polka.codes
import { describe, expect, it } from 'bun:test'
import { mkdirSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { type ScriptConfig, scriptSchema } from '@polka-codes/core'
import { validateScriptPath, validateScriptPermissions } from '../runner'

describe('validateScriptPath', () => {
  const testDir = join(process.cwd(), 'test-scripts')

  // Setup test directory
  const setup = () => {
    try {
      mkdirSync(testDir, { recursive: true })
    } catch {
      // Directory already exists
    }
  }

  // Cleanup test directory
  const cleanup = () => {
    try {
      rmSync(testDir, { recursive: true, force: true })
    } catch {
      // Directory doesn't exist
    }
  }

  // Create a test file
  const createTestFile = (name: string) => {
    writeFileSync(join(testDir, name), 'test content')
  }

  it('should accept a valid TypeScript script path within project', () => {
    setup()
    createTestFile('valid.ts')

    expect(() => validateScriptPath('test-scripts/valid.ts', process.cwd())).not.toThrow()

    cleanup()
  })

  it('should reject YAML workflow files (ScriptRunner only accepts TypeScript)', () => {
    setup()
    createTestFile('workflow.yml')

    expect(() => validateScriptPath('test-scripts/workflow.yml', process.cwd())).toThrow(
      'Script validation failed: Script must be .ts file: test-scripts/workflow.yml',
    )

    cleanup()
  })

  it('should reject paths outside project directory', () => {
    expect(() => validateScriptPath('../etc/passwd', process.cwd())).toThrow(
      "Script validation failed: Script path '../etc/passwd' is outside project directory",
    )
  })

  it('should reject non-existent files', () => {
    expect(() => validateScriptPath('does-not-exist.ts', process.cwd())).toThrow(
      'Script validation failed: Script file not found: does-not-exist.ts',
    )
  })

  it('should reject files with invalid extensions', () => {
    setup()
    createTestFile('invalid.js')

    expect(() => validateScriptPath('test-scripts/invalid.js', process.cwd())).toThrow(
      'Script validation failed: Script must be .ts file: test-scripts/invalid.js',
    )

    cleanup()
  })

  it('should reject paths with directory traversal attempts', () => {
    setup()
    createTestFile('safe.ts')

    expect(() => validateScriptPath('test-scripts/../../../etc/passwd', process.cwd())).toThrow()

    cleanup()
  })
})

describe('validateScriptPermissions', () => {
  it('should accept string scripts (no permissions)', () => {
    const script: ScriptConfig = 'bun run test'
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept command scripts (no permissions)', () => {
    const script: ScriptConfig = { command: 'bun test', description: 'Run tests' }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept workflow scripts (no permissions)', () => {
    const script: ScriptConfig = { workflow: './test.yml' }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept valid fs permissions', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { fs: 'read' },
    }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept valid network permissions', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { network: true },
    }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept valid subprocess permissions', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { subprocess: true },
    }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should accept all permissions', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { fs: 'write', network: true, subprocess: true },
    }
    expect(() => validateScriptPermissions(script)).not.toThrow()
  })

  it('should reject invalid fs permission', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { fs: 'invalid' as any },
    }
    expect(() => validateScriptPermissions(script)).toThrow(
      "Script validation failed: Invalid fs permission: invalid. Must be 'read', 'write', or 'none'",
    )
  })

  it('should reject invalid network permission', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { network: 'invalid' as any },
    }
    expect(() => validateScriptPermissions(script)).toThrow('Script validation failed: Invalid network permission: must be true or false')
  })

  it('should reject invalid subprocess permission', () => {
    const script: ScriptConfig = {
      script: './test.ts',
      permissions: { subprocess: 'invalid' as any },
    }
    expect(() => validateScriptPermissions(script)).toThrow(
      'Script validation failed: Invalid subprocess permission: must be true or false',
    )
  })
})

describe('scriptSchema', () => {
  it('should validate string scripts', () => {
    const result = scriptSchema.safeParse('bun run test')
    expect(result.success).toBe(true)
  })

  it('should validate command scripts', () => {
    const result = scriptSchema.safeParse({ command: 'bun test', description: 'Run tests' })
    expect(result.success).toBe(true)
  })

  it('should validate workflow scripts', () => {
    const result = scriptSchema.safeParse({
      workflow: './test.yml',
      description: 'Test workflow',
    })
    expect(result.success).toBe(true)
  })

  it('should validate TypeScript scripts', () => {
    const result = scriptSchema.safeParse({
      script: './test.ts',
      description: 'Test script',
      permissions: { fs: 'write', network: true },
      timeout: 60000,
    })
    expect(result.success).toBe(true)
  })

  it('should reject scripts with invalid fields', () => {
    const result = scriptSchema.safeParse({
      script: './test.ts',
      invalidField: 'value',
    })
    expect(result.success).toBe(false)
  })

  it('should reject empty object', () => {
    const result = scriptSchema.safeParse({})
    expect(result.success).toBe(false)
  })
})
