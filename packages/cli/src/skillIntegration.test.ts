// generated by polka.codes
import { afterEach, beforeEach, describe, expect, it } from 'bun:test'
import { mkdirSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { createSkillContext, generateSkillsSystemPrompt } from './skillIntegration'

describe('skillIntegration', () => {
  const testDir = join(process.cwd(), 'test-skill-integration')
  const skillsDir = join(testDir, '.claude', 'skills')

  beforeEach(() => {
    mkdirSync(skillsDir, { recursive: true })
  })

  afterEach(() => {
    rmSync(testDir, { recursive: true, force: true })
  })

  function createTestSkill(name: string, description: string, content?: string) {
    const skillDir = join(skillsDir, name)
    mkdirSync(skillDir, { recursive: true })
    const fullContent = `---
name: ${name}
description: ${description}
---

${content || '# Test Skill'}
`
    writeFileSync(join(skillDir, 'SKILL.md'), fullContent)
    return skillDir
  }

  describe('generateSkillsSystemPrompt', () => {
    function createMockSkill(name: string, description: string, source: 'project' | 'personal' | 'plugin', allowedTools?: string[]) {
      return {
        metadata: { name, description, allowedTools },
        source,
        content: '# Test',
        files: new Map(),
        path: '/test',
      }
    }

    it('should return empty string when no skills provided', () => {
      const result = generateSkillsSystemPrompt([])
      expect(result).toBe('')
    })

    it('should generate prompt with project skills', () => {
      const skills = [createMockSkill('test-skill', 'A test skill', 'project')]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('## Available Skills')
      expect(result).toContain('### test-skill')
      expect(result).toContain('ðŸ“ Project')
      expect(result).toContain('A test skill')
    })

    it('should generate prompt with personal skills', () => {
      const skills = [createMockSkill('personal-skill', 'A personal skill', 'personal')]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('ðŸ  Personal')
      expect(result).toContain('personal-skill')
    })

    it('should generate prompt with plugin skills', () => {
      const skills = [createMockSkill('plugin-skill', 'A plugin skill', 'plugin')]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('ðŸ”Œ Plugin')
      expect(result).toContain('plugin-skill')
    })

    it('should include allowed tools in prompt', () => {
      const skills = [createMockSkill('test-skill', 'A test skill', 'project', ['readFile', 'writeToFile'])]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('**Allowed Tools:**')
      expect(result).toContain('readFile, writeToFile')
    })

    it('should include multiple skills', () => {
      const skills = [createMockSkill('skill-one', 'First skill', 'project'), createMockSkill('skill-two', 'Second skill', 'personal')]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('### skill-one')
      expect(result).toContain('### skill-two')
      expect(result).toContain('First skill')
      expect(result).toContain('Second skill')
    })

    it('should include usage instructions', () => {
      const skills = [createMockSkill('test-skill', 'A test skill', 'project')]

      const result = generateSkillsSystemPrompt(skills)

      expect(result).toContain('**Using Skills:**')
      expect(result).toContain('`loadSkill`')
      expect(result).toContain('`listSkills`')
    })
  })

  describe('createSkillContext', () => {
    it('should create context with discovered skills', async () => {
      createTestSkill('skill-one', 'First skill')
      createTestSkill('skill-two', 'Second skill')

      const context = await createSkillContext(testDir)

      expect(context.availableSkills).toHaveLength(2)
      const skillNames = context.availableSkills.map((s) => s.metadata.name).sort()
      expect(skillNames).toEqual(['skill-one', 'skill-two'])
    })

    it('should create context with empty skills when none exist', async () => {
      const context = await createSkillContext(testDir)

      expect(context.availableSkills).toHaveLength(0)
      expect(context.activeSkill).toBeNull()
    })

    it('should use process.cwd() when no cwd provided', async () => {
      createTestSkill('test-skill', 'A test skill')

      // This will discover skills in the actual test directory
      const context = await createSkillContext()

      // Just verify it returns a valid context structure
      expect(context).toBeDefined()
      expect(context.availableSkills).toBeArray()
      expect(context.activeSkill).toBeNull()
      expect(context.skillLoadingHistory).toBeArray()
    })

    it('should initialize with null active skill', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await createSkillContext(testDir)

      expect(context.activeSkill).toBeNull()
    })

    it('should initialize with empty loading history', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await createSkillContext(testDir)

      expect(context.skillLoadingHistory).toHaveLength(0)
    })
  })
})
