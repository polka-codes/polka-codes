/**
 * Run custom scripts command
 *
 * Provides explicit script execution with:
 * - List all available scripts
 * - Execute specific scripts by name
 * - Pass arguments to scripts
 * Generated by polka.codes
 */

import { loadConfig } from '@polka-codes/cli-shared'
import type { Config, Logger, ScriptConfig } from '@polka-codes/core'
import { Command } from 'commander'
import { createLogger } from '../logger'
import { executeScript, ScriptExecutionFailedError } from '../script/executor'

export const runCommand = new Command('run')
  .description('Run custom scripts')
  .argument('[script-name]', 'Name of the script to run')
  .option('--list', 'List all available scripts')
  .option('--args <args...>', 'Arguments to pass to the script')
  .action(async (scriptName, options, command: Command) => {
    const globalOpts = (command.parent ?? command).opts()
    const { verbose } = globalOpts
    const logger = createLogger({
      verbose,
    })

    const config = await loadConfig()

    // Handle --list flag
    if (options.list) {
      listAvailableScripts(config, logger)
      return
    }

    // Validate script name provided
    if (!scriptName) {
      logger.error('Error: No script name provided')
      logger.info('Usage: polka run <script-name>')
      logger.info('   Use --list to see available scripts')
      process.exit(1)
    }

    // Find script in config
    const script = config?.scripts?.[scriptName]
    if (!script) {
      logger.error(`Error: Script '${scriptName}' not found`)
      logger.info('Available scripts:')
      listAvailableScripts(config, logger)
      process.exit(1)
    }

    // Execute the script
    try {
      await executeScript(script, scriptName, logger, options.args || [])
    } catch (error) {
      if (error instanceof ScriptExecutionFailedError) {
        process.exit(error.exitCode)
      }
      throw error
    }
  })

/**
 * List all available scripts from config
 */
function listAvailableScripts(config: Config | undefined, logger: Logger) {
  const scripts = config?.scripts

  if (!scripts || Object.keys(scripts).length === 0) {
    logger.info('No custom scripts configured.')
    logger.info('Add scripts to your .polkacodes.yml:')
    logger.info('  scripts:')
    logger.info('    my-script:')
    logger.info('      script: ./scripts/my-script.ts')
    logger.info('      description: My custom automation')
    return
  }

  logger.info('Available scripts:')
  for (const [name, scriptConfig] of Object.entries(scripts)) {
    const type = getScriptType(scriptConfig)
    const icon = type === 'ts' ? 'âš¡' : type === 'workflow' ? 'ðŸ”„' : type === 'command' ? 'ðŸ’»' : 'ðŸ“œ'
    const desc = getScriptDescription(scriptConfig)
    logger.info(`  ${icon} ${name}${desc ? ` - ${desc}` : ''}`)
  }
}

/**
 * Get the type of a script for display purposes
 */
function getScriptType(script: ScriptConfig): string {
  if (typeof script === 'string') {
    return 'shell'
  }
  if ('command' in script) {
    return 'command'
  }
  if ('script' in script) {
    return 'ts'
  }
  if ('workflow' in script) {
    return 'workflow'
  }
  return 'unknown'
}

/**
 * Get description from a script configuration
 */
function getScriptDescription(script: ScriptConfig): string | undefined {
  if (typeof script === 'string') {
    return undefined
  }
  return script.description
}
