// generated by polka.codes
import { afterEach, beforeEach, describe, expect, it } from 'bun:test'
import { mkdirSync, readFileSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { loadConfig } from '@polka-codes/cli-shared'

describe('Command Detection Integration Tests', () => {
  const testProjectDir = join(process.cwd(), 'test-command-detection')
  const configPath = join(testProjectDir, '.polkacodes.yml')
  const scriptsDir = join(testProjectDir, '.polka-scripts')

  beforeEach(() => {
    // Create test project directory
    mkdirSync(testProjectDir, { recursive: true })
    mkdirSync(scriptsDir, { recursive: true })
  })

  afterEach(() => {
    // Cleanup test project directory
    try {
      rmSync(testProjectDir, { recursive: true, force: true })
    } catch {
      // Directory doesn't exist
    }
  })

  describe('Config loading with scripts', () => {
    it('should load config with string script', async () => {
      const configContent = `
scripts:
  test: "bun test"
  build: "bun run build"
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()
      expect(config?.scripts?.test).toBe('bun test')
      expect(config?.scripts?.build).toBe('bun run build')
    })

    it('should load config with command object script', async () => {
      const configContent = `
scripts:
  deploy:
    command: "bun run deploy"
    description: Deploy to production
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()
      const deployScript = config?.scripts?.deploy
      expect(deployScript).toBeDefined()
      if (typeof deployScript === 'object' && 'command' in deployScript) {
        expect(deployScript.command).toBe('bun run deploy')
        expect(deployScript.description).toBe('Deploy to production')
      } else {
        expect(true).toBe(false) // Should be a command object
      }
    })

    it('should load config with TypeScript script', async () => {
      writeFileSync(
        join(scriptsDir, 'deploy.ts'),
        `
export async function main(args: string[]) {
  return { deployed: true }
}
`,
      )

      const configContent = `
scripts:
  deploy:
    script: .polka-scripts/deploy.ts
    description: Deploy to production
    permissions:
      network: true
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()
      const deployScript = config?.scripts?.deploy
      expect(deployScript).toBeDefined()
      if (typeof deployScript === 'object' && 'script' in deployScript) {
        expect(deployScript.script).toBe('.polka-scripts/deploy.ts')
        expect(deployScript.permissions?.network).toBe(true)
      } else {
        expect(true).toBe(false) // Should be a script object
      }
    })

    it('should load config with workflow script', async () => {
      const configContent = `
scripts:
  workflow-test:
    workflow: .polka-scripts/test.yml
    description: Test workflow
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()
      const workflowScript = config?.scripts?.['workflow-test']
      expect(workflowScript).toBeDefined()
      if (typeof workflowScript === 'object' && 'workflow' in workflowScript) {
        expect(workflowScript.workflow).toBe('.polka-scripts/test.yml')
      } else {
        expect(true).toBe(false) // Should be a workflow object
      }
    })
  })

  describe('Script validation', () => {
    it('should validate all script types in config', async () => {
      writeFileSync(
        join(scriptsDir, 'deploy.ts'),
        `
export async function main(args: string[]) {
  return { deployed: true }
}
`,
      )

      const configContent = `
scripts:
  test: "bun test"
  build:
    command: "bun run build"
    description: Build project
  deploy:
    script: .polka-scripts/deploy.ts
    permissions:
      fs: write
  workflow-test:
    workflow: .polka-scripts/test.yml
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()

      // Verify all scripts are present
      expect(config?.scripts?.test).toBeDefined()
      expect(config?.scripts?.build).toBeDefined()
      expect(config?.scripts?.deploy).toBeDefined()
      expect(config?.scripts?.['workflow-test']).toBeDefined()
    })

    it('should preserve script metadata', async () => {
      const configContent = `
scripts:
  complex-script:
    script: .polka-scripts/complex.ts
    description: A complex script with many options
    permissions:
      fs: write
      network: true
      subprocess: true
    timeout: 60000
    memory: 512
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      const script = config?.scripts?.['complex-script']
      expect(script).toBeDefined()

      if (typeof script === 'object' && 'script' in script) {
        expect(script.description).toBe('A complex script with many options')
        expect(script.permissions?.fs).toBe('write')
        expect(script.permissions?.network).toBe(true)
        expect(script.permissions?.subprocess).toBe(true)
        expect(script.timeout).toBe(60000)
        expect(script.memory).toBe(512)
      } else {
        expect(true).toBe(false) // Should be a script object
      }
    })
  })

  describe('Script listing', () => {
    it('should list all available scripts from config', async () => {
      const configContent = `
scripts:
  test: "bun test"
  lint: "bun run lint"
  format: "bun run format"
  deploy:
    script: .polka-scripts/deploy.ts
    description: Deploy to production
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()

      const scriptNames = Object.keys(config?.scripts || {})
      expect(scriptNames).toContain('test')
      expect(scriptNames).toContain('lint')
      expect(scriptNames).toContain('format')
      expect(scriptNames).toContain('deploy')
    })

    it('should handle empty scripts section', async () => {
      const configContent = `
scripts: {}
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      expect(config?.scripts).toBeDefined()
      expect(Object.keys(config?.scripts || {})).toHaveLength(0)
    })

    it('should handle missing scripts section', async () => {
      const configContent = `
defaultProvider: openai
defaultModel: gpt-4
`
      writeFileSync(configPath, configContent)

      const config = await loadConfig([], testProjectDir)
      expect(config).toBeDefined()
      // scripts may be undefined
      expect(config?.scripts).toBeUndefined()
    })
  })

  describe('Config updates', () => {
    it('should preserve existing config when adding scripts', () => {
      const initialConfig = `# Project configuration
defaultProvider: openai
defaultModel: gpt-4

maxMessageCount: 50
`
      writeFileSync(configPath, initialConfig)

      // Read current config
      const currentContent = readFileSync(configPath, 'utf-8')

      // Append scripts section
      const updatedContent = `${currentContent}
scripts:
  new-script: "echo new"
`
      writeFileSync(configPath, updatedContent)

      const newContent = readFileSync(configPath, 'utf-8')
      expect(newContent).toContain('defaultProvider: openai')
      expect(newContent).toContain('defaultModel: gpt-4')
      expect(newContent).toContain('maxMessageCount:')
      expect(newContent).toContain('scripts:')
      expect(newContent).toContain('new-script')
    })
  })
})
