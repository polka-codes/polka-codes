/**
 * Skills management command
 *
 * Provides commands for managing Agent Skills:
 * - List all available skills
 * - Show skill details
 * - Validate skill format
 * Generated by polka.codes
 */

import {
  SkillDiscoveryService,
  SOURCE_ICONS,
  validateSkillMetadata,
  validateSkillReferences,
  validateSkillSecurity,
} from '@polka-codes/core'
import { Command } from 'commander'
import { createLogger } from '../logger'

export const skillsCommand = new Command('skills').description('Manage Agent Skills')

// List available skills
skillsCommand
  .command('list')
  .description('List all available skills')
  .action(async () => {
    const logger = createLogger({ verbose: 0 })

    const service = new SkillDiscoveryService({ cwd: process.cwd() })
    const skills = await service.discoverAll()

    if (skills.length === 0) {
      logger.info('No skills found.')
      logger.info('Create a skill with: polka init skill <name>')
      logger.info('Or create one manually at .claude/skills/<skill-name>/SKILL.md')
      return
    }

    logger.info(`Found ${skills.length} skill${skills.length !== 1 ? 's' : ''}:`)
    logger.info('')

    for (const skill of skills) {
      const sourceIcon = SOURCE_ICONS[skill.source]
      logger.info(`${sourceIcon} ${skill.metadata.name}`)
      logger.info(`   ${skill.metadata.description}`)

      // Show additional info
      const fileCount = skill.files.size
      if (fileCount > 0) {
        logger.info(`   ${fileCount} additional file${fileCount !== 1 ? 's' : ''}`)
      }
      logger.info('')
    }
  })

// Show skill details
skillsCommand
  .command('show')
  .description('Show details for a specific skill')
  .argument('<skill-name>', 'Name of the skill')
  .option('--full', 'Show full content including supporting files')
  .action(async (skillName, options) => {
    const logger = createLogger({ verbose: 0 })

    const service = new SkillDiscoveryService({ cwd: process.cwd() })
    const skills = await service.discoverAll()
    const skill = skills.find((s) => s.metadata.name === skillName)

    if (!skill) {
      logger.error(`Skill '${skillName}' not found`)
      logger.info('Run "polka skills list" to see available skills')
      process.exit(1)
    }

    logger.info(`#${skill.metadata.name}`)
    logger.info('')
    logger.info(`Source: ${skill.source}`)
    logger.info(`Path: ${skill.path}`)
    logger.info('')
    logger.info(`Description:`)
    logger.info(`  ${skill.metadata.description}`)

    if (skill.metadata.allowedTools && skill.metadata.allowedTools.length > 0) {
      logger.info('')
      logger.info(`Allowed Tools: ${skill.metadata.allowedTools.join(', ')}`)
    }

    logger.info('')
    logger.info(`Content:`)

    if (options.full) {
      logger.info(skill.content)

      if (skill.files.size > 0) {
        logger.info('')
        logger.info(`Supporting Files (${skill.files.size}):`)
        for (const [name, content] of skill.files) {
          logger.info('')
          logger.info(`### ${name}`)
          logger.info(content)
        }
      }
    } else {
      // Show preview (first 10 lines)
      const lines = skill.content.split('\n')
      const preview = lines.slice(0, 10).join('\n')
      logger.info(preview)

      if (lines.length > 10) {
        logger.info('')
        logger.info('...')
        logger.info(`(Use --full to see complete content)`)
      }

      // List supporting files without showing content
      if (skill.files.size > 0) {
        logger.info('')
        logger.info(`Supporting Files (${skill.files.size}):`)
        for (const [name] of skill.files.keys()) {
          logger.info(`  - ${name}`)
        }
        logger.info('')
        logger.info('(Use --full to see file contents)')
      }
    }
  })

// Validate skill
skillsCommand
  .command('validate')
  .description("Validate a skill's structure and content")
  .argument('[skill-name]', 'Name of the skill (validates all if not provided)')
  .action(async (skillName) => {
    const logger = createLogger({ verbose: 0 })

    const service = new SkillDiscoveryService({ cwd: process.cwd() })
    const skills = await service.discoverAll()

    const skillsToValidate = skillName ? skills.filter((s) => s.metadata.name === skillName) : skills

    if (skillsToValidate.length === 0) {
      logger.error(`No skill${skillName ? ` '${skillName}'` : 's'} found`)
      process.exit(1)
    }

    let hasErrors = false
    let totalWarnings = 0

    for (const skill of skillsToValidate) {
      logger.info(`Validating ${skill.metadata.name}...`)

      let skillHasErrors = false

      // Check metadata
      const errors = validateSkillMetadata(skill)
      for (const error of errors) {
        logger.error(`  ❌ ${error}`)
        hasErrors = true
        skillHasErrors = true
      }

      // Check security
      try {
        validateSkillSecurity(skill)
        logger.info(`  ✅ Security validation passed`)
      } catch (error) {
        if (error instanceof Error) {
          logger.error(`  ❌ Security: ${error.message}`)
          hasErrors = true
          skillHasErrors = true
        }
      }

      // Check references
      const warnings = validateSkillReferences(skill)
      for (const warning of warnings) {
        logger.warn(`  ⚠️  ${warning}`)
        totalWarnings++
      }

      // No errors for this skill means valid
      if (!skillHasErrors) {
        logger.info(`  ✅ Valid`)
      }

      logger.info('')
    }

    if (hasErrors) {
      process.exit(1)
    }

    if (totalWarnings > 0) {
      logger.info(`Validation complete with ${totalWarnings} warning${totalWarnings !== 1 ? 's' : ''}`)
    } else {
      logger.info('All validations passed!')
    }
  })
