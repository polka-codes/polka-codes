// Integration test to verify review --json outputs valid JSON without extra logging
// generated by polka.codes

import { describe, expect, mock, test } from 'bun:test'
import { createLogger } from '../logger'

describe('Review command JSON output integrity', () => {
  test('silent logger (verbose: -1) should not write to stderr', () => {
    // This test verifies the fix for the bug where --json flag emitted non-JSON output.
    // The root cause was that logger calls in the workflow were not silenced.
    // When verbose is -1, all logger methods should be no-ops.

    const silentLogger = createLogger({ verbose: -1 })
    const normalLogger = createLogger({ verbose: 0 })

    // Mock process.stderr.write to track calls
    const writeMock = mock(() => true)
    const originalWrite = process.stderr.write

    process.stderr.write = writeMock

    try {
      // Silent logger - no writes should occur
      silentLogger.debug('debug message')
      silentLogger.info('info message')
      silentLogger.warn('warning message')
      silentLogger.error('error message')
      expect(writeMock).toHaveBeenCalledTimes(0)

      // Normal logger - writes should occur
      normalLogger.info('normal message')
      normalLogger.warn('normal warning')
      expect(writeMock).toHaveBeenCalled()
    } finally {
      process.stderr.write = originalWrite
    }
  })
})
