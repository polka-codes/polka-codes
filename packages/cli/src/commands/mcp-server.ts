// generated by polka.codes

import { Command } from 'commander'
import { createLogger } from '../logger'
import { McpServer } from '../mcp-server/server'
import { createPolkaCodesServerTools } from '../mcp-server/tools'

export const mcpServerCommand = new Command('mcp-server')
  .description('Start polka-codes as an MCP server')
  .option('-v, --verbose', 'Enable verbose logging', false)
  .action(async (options: { verbose: boolean }) => {
    const logger = createLogger({
      verbose: options.verbose ? 1 : 0,
    })

    // Print usage information
    console.log('')
    console.log('╔════════════════════════════════════════════════════════════════╗')
    console.log('║           Polka Codes MCP Server                                 ║')
    console.log('╚════════════════════════════════════════════════════════════════╝')
    console.log('')
    console.log('Available Tools:')

    // Create MCP server
    const server = new McpServer(
      {
        serverInfo: {
          name: 'polka-codes',
          version: '1.0.0',
        },
        capabilities: {
          tools: true,
          resources: false,
          prompts: false,
        },
      },
      logger,
    )

    // Register tools
    const tools = createPolkaCodesServerTools()
    server.registerTools(tools)

    // Print available tools
    for (const tool of tools) {
      const requiredParams = (tool.inputSchema.required || []).filter((param: string) => param in (tool.inputSchema.properties || {}))
      console.log(`  • ${tool.name}`)
      console.log(`    ${tool.description}`)
      if (requiredParams.length > 0) {
        console.log(`    Required: ${requiredParams.join(', ')}`)
      }
      console.log('')
    }

    console.log('Client Configuration Examples:')
    console.log('')
    console.log('  Claude Desktop (~/Library/Application Support/Claude/claude_desktop_config.json):')
    console.log('  {')
    console.log('    "mcpServers": {')
    console.log('      "polka-codes": {')
    console.log('        "command": "polka",')
    console.log('        "args": ["mcp-server"]')
    console.log('      }')
    console.log('    }')
    console.log('  }')
    console.log('')
    console.log('  Continue.dev (~/.continue/config.json):')
    console.log('  {')
    console.log('    "experimental": {')
    console.log('      "mcpServers": [')
    console.log('        {')
    console.log('          "name": "polka-codes",')
    console.log('          "command": "polka",')
    console.log('          "args": ["mcp-server"]')
    console.log('        }')
    console.log('      ]')
    console.log('    }')
    console.log('  }')
    console.log('')
    console.log('Testing with MCP Inspector:')
    console.log('  $ npm install -g @modelcontextprotocol/inspector')
    console.log('  $ mcp-inspector stdio polka mcp-server')
    console.log('')
    console.log('Press Ctrl+C to stop the server')
    console.log('═════════════════════════════════════════════════════════════════')
    console.log('')

    logger.info('Starting MCP server...')

    // Start server
    await server.start()

    logger.info('MCP server is running and listening for connections...')

    // Handle shutdown gracefully
    process.on('SIGINT', async () => {
      console.log('')
      logger.info('Shutting down MCP server...')
      await server.stop()
      process.exit(0)
    })

    process.on('SIGTERM', async () => {
      logger.info('Shutting down MCP server...')
      await server.stop()
      process.exit(0)
    })
  })
