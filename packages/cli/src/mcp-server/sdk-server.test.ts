// Unit tests for SDK-based MCP server
// generated by polka.codes

import { describe, expect, test } from 'bun:test'
import { createPolkaCodesMcpServer } from './sdk-server'
import { createPolkaCodesServerTools } from './tools'
import type { McpServerTool } from './types'

// Mock logger
const mockLogger = {
  debug: () => {},
  info: () => {},
  warn: () => {},
  error: () => {},
}

describe('SDK-based McpServer', () => {
  describe('Server Creation', () => {
    test('should create server with SDK', () => {
      const tools: McpServerTool[] = []
      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
      expect(server.isConnected()).toBe(false)
    })

    test('should have correct server info', () => {
      const tools: McpServerTool[] = []
      const server = createPolkaCodesMcpServer(tools, mockLogger)

      // Access underlying server to check info
      expect(server.server).toBeDefined()
    })

    test('should register tools successfully', () => {
      const tools: McpServerTool[] = [
        {
          name: 'test_tool',
          description: 'A test tool',
          inputSchema: {
            type: 'object',
            properties: {
              arg1: { type: 'string' },
            },
          },
          handler: async (args) => {
            return { result: args }
          },
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
      expect(server.isConnected()).toBe(false)
    })

    test('should register multiple tools', () => {
      const tools: McpServerTool[] = [
        {
          name: 'tool1',
          description: 'Tool 1',
          inputSchema: {},
          handler: async () => ({ result: 'tool1' }),
        },
        {
          name: 'tool2',
          description: 'Tool 2',
          inputSchema: {},
          handler: async () => ({ result: 'tool2' }),
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should handle tool with complex input schema', () => {
      const tools: McpServerTool[] = [
        {
          name: 'complex_tool',
          description: 'Tool with complex schema',
          inputSchema: {
            type: 'object',
            properties: {
              string: { type: 'string' },
              number: { type: 'number' },
              boolean: { type: 'boolean' },
              array: {
                type: 'array',
                items: { type: 'string' },
              },
              object: {
                type: 'object',
                properties: {
                  nested: { type: 'string' },
                },
              },
            },
            required: ['string', 'number'],
          },
          handler: async (args) => args,
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })
  })

  describe('Tool Handler Behavior', () => {
    test('should create tool handler that returns valid MCP response', async () => {
      const tools: McpServerTool[] = [
        {
          name: 'echo',
          description: 'Echo back arguments',
          inputSchema: {
            type: 'object',
            properties: {
              message: { type: 'string' },
            },
            required: ['message'],
          },
          handler: async (args) => {
            return { echoed: args.message }
          },
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should create tool handler that stringifies object results', async () => {
      const tools: McpServerTool[] = [
        {
          name: 'object_result',
          description: 'Returns object',
          inputSchema: {},
          handler: async () => {
            return { key: 'value', nested: { prop: 123 } }
          },
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should create tool handler that handles string results', async () => {
      const tools: McpServerTool[] = [
        {
          name: 'string_result',
          description: 'Returns string',
          inputSchema: {},
          handler: async () => {
            return 'Plain string result'
          },
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should create tool handler that logs errors locally', async () => {
      const testLogger = {
        ...mockLogger,
        error: () => {},
      }

      const tools: McpServerTool[] = [
        {
          name: 'failing_tool',
          description: 'A tool that fails',
          inputSchema: {},
          handler: async () => {
            throw new Error('Tool execution failed')
          },
        },
      ]

      // Server should be created successfully with logger
      const server = createPolkaCodesMcpServer(tools, testLogger)

      expect(server).toBeDefined()
    })
  })

  describe('Tool Registration Edge Cases', () => {
    test('should handle tool with empty input schema', () => {
      const tools: McpServerTool[] = [
        {
          name: 'no_params',
          description: 'Tool with no parameters',
          inputSchema: {},
          handler: async () => ({ result: 'ok' }),
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should handle tool with no required parameters', () => {
      const tools: McpServerTool[] = [
        {
          name: 'optional_params',
          description: 'Tool with optional parameters',
          inputSchema: {
            type: 'object',
            properties: {
              optional1: { type: 'string' },
              optional2: { type: 'number' },
            },
          },
          handler: async (args) => args,
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should handle tool with nested properties', () => {
      const tools: McpServerTool[] = [
        {
          name: 'nested',
          description: 'Tool with nested properties',
          inputSchema: {
            type: 'object',
            properties: {
              config: {
                type: 'object',
                properties: {
                  enabled: { type: 'boolean' },
                  name: { type: 'string' },
                },
              },
            },
          },
          handler: async (args) => args,
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should handle tool with array properties', () => {
      const tools: McpServerTool[] = [
        {
          name: 'array_tool',
          description: 'Tool with array properties',
          inputSchema: {
            type: 'object',
            properties: {
              items: {
                type: 'array',
                items: {
                  type: 'object',
                  properties: {
                    id: { type: 'string' },
                    value: { type: 'number' },
                  },
                },
              },
            },
          },
          handler: async (args) => args,
        },
      ]

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })
  })

  describe('Polka-Codes Tools', () => {
    test('should work with polka-codes server tools', () => {
      const tools = createPolkaCodesServerTools(mockLogger)

      expect(tools.length).toBeGreaterThan(0)

      const server = createPolkaCodesMcpServer(tools, mockLogger)

      expect(server).toBeDefined()
    })

    test('should register all polka-codes tools', () => {
      const tools = createPolkaCodesServerTools(mockLogger)

      const toolNames = tools.map((t: McpServerTool) => t.name)

      expect(toolNames).toContain('code')
      expect(toolNames).toContain('review')
      expect(toolNames).toContain('plan')
      expect(toolNames).toContain('fix')
      expect(toolNames).toContain('epic')
      expect(toolNames).toContain('commit')
    })
  })

  describe('Error Handling', () => {
    test('should warn but not throw for invalid tool name', () => {
      // SDK warns but doesn't throw for empty tool names
      const invalidTool: McpServerTool = {
        name: '', // Invalid: empty name
        description: 'Invalid tool',
        inputSchema: {},
        handler: async () => ({}),
      }

      expect(() => {
        const server = createPolkaCodesMcpServer([invalidTool], mockLogger)
        expect(server).toBeDefined()
      }).not.toThrow()
    })

    test('should not throw if handler throws during execution', () => {
      const tools: McpServerTool[] = [
        {
          name: 'throws_error',
          description: 'Tool that throws',
          inputSchema: {},
          handler: async () => {
            throw new Error('Handler error')
          },
        },
      ]

      // Server creation should succeed (handler is not called during registration)
      expect(() => {
        const server = createPolkaCodesMcpServer(tools, mockLogger)
        expect(server).toBeDefined()
      }).not.toThrow()
    })
  })

  describe('Logger Integration', () => {
    test('should work without logger', () => {
      const tools: McpServerTool[] = [
        {
          name: 'test',
          description: 'Test tool',
          inputSchema: {},
          handler: async () => ({ result: 'ok' }),
        },
      ]

      expect(() => {
        const server = createPolkaCodesMcpServer(tools)
        expect(server).toBeDefined()
      }).not.toThrow()
    })

    test('should use logger for registration debug messages', () => {
      let debugCalled = false
      const testLogger = {
        ...mockLogger,
        debug: () => {
          debugCalled = true
        },
      }

      const tools: McpServerTool[] = [
        {
          name: 'test',
          description: 'Test tool',
          inputSchema: {},
          handler: async () => ({ result: 'ok' }),
        },
      ]

      createPolkaCodesMcpServer(tools, testLogger)

      expect(debugCalled).toBe(true)
    })

    test('should use logger for error messages', () => {
      let errorCalled = false
      const testLogger = {
        ...mockLogger,
        error: () => {
          errorCalled = true
        },
      }

      const tools: McpServerTool[] = [
        {
          name: 'test',
          description: 'Test tool',
          inputSchema: {},
          handler: async () => ({ result: 'ok' }),
        },
      ]

      // This should not throw, and error logger should not be called during successful registration
      expect(() => {
        createPolkaCodesMcpServer(tools, testLogger)
      }).not.toThrow()

      expect(errorCalled).toBe(false)
    })
  })
})
