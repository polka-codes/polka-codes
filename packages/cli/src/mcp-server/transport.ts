// generated by polka.codes

import { EventEmitter } from 'node:events'

/**
 * Server-side transport for MCP protocol (stdio)
 * Handles incoming requests and sends responses
 */
export class McpServerTransport extends EventEmitter {
  private buffer = ''

  constructor() {
    super()
    this.setupStdio()
  }

  /**
   * Setup stdio for communication with MCP client
   */
  private setupStdio(): void {
    // Listen for messages from stdin
    process.stdin.setEncoding('utf-8')
    process.stdin.on('data', (data: string) => {
      this.handleData(data.toString())
    })

    // Handle stdin errors
    process.stdin.on('error', (error: Error) => {
      this.emit('error', error)
    })
  }

  /**
   * Handle incoming data from stdin
   */
  private handleData(data: string): void {
    this.buffer += data

    // Process complete messages (separated by newlines)
    const lines = this.buffer.split('\n')
    this.buffer = lines.pop() || ''

    for (const line of lines) {
      if (!line.trim()) continue

      try {
        const message = JSON.parse(line)
        this.emit('message', message)
      } catch (_error) {
        this.emit('error', new Error(`Failed to parse message: ${line}`))
      }
    }
  }

  /**
   * Send a response to the client
   */
  sendResponse(id: number | string, result: unknown): void {
    const response = {
      jsonrpc: '2.0',
      id,
      result,
    }
    this.sendMessage(response)
  }

  /**
   * Send an error response to the client
   */
  sendError(id: number | string, code: number, message: string, data?: unknown): void {
    const response = {
      jsonrpc: '2.0',
      id,
      error: {
        code,
        message,
        data,
      },
    }
    this.sendMessage(response)
  }

  /**
   * Send a notification to the client
   */
  sendNotification(method: string, params?: unknown): void {
    const notification = {
      jsonrpc: '2.0',
      method,
      params,
    }
    this.sendMessage(notification)
  }

  /**
   * Send a raw message to stdout
   */
  private sendMessage(message: Record<string, unknown>): void {
    const json = JSON.stringify(message)
    process.stdout.write(`${json}\n`)
  }

  /**
   * Start listening for messages
   */
  start(): void {
    // Already listening via setupStdio
  }

  /**
   * Stop listening for messages
   */
  stop(): void {
    process.stdin.pause()
  }
}
