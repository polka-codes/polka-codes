// generated by polka.codes

import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js'
import type { Logger } from '@polka-codes/core'
import type { DefaultProviderConfig, McpServerTool, McpServerToolContext } from './types.js'

/**
 * Create an MCP server using the official SDK
 *
 * @param tools - Array of tools to register
 * @param logger - Optional logger instance
 * @param defaultProvider - Optional default provider configuration
 * @returns Configured MCP server instance
 */
export function createPolkaCodesMcpServer(tools: McpServerTool[], logger?: Logger, defaultProvider?: DefaultProviderConfig): McpServer {
  // Create server instance with SDK
  const server = new McpServer(
    {
      name: 'polka-codes',
      version: '1.0.0',
    },
    {
      capabilities: {
        tools: {},
        resources: {},
        prompts: {},
      },
    },
  )

  // Create context for tool handlers
  const context: McpServerToolContext = {
    logger: console as unknown as Logger,
    defaultProvider,
  }
  if (logger) {
    context.logger = logger
  }

  // Register polka-codes tools
  for (const tool of tools) {
    try {
      server.registerTool(
        tool.name,
        {
          description: tool.description,
          inputSchema: tool.inputSchema,
        },
        async (args: Record<string, unknown>) => {
          try {
            // Call polka-codes tool handler with context
            const result = await tool.handler(args, context)

            // Return result in MCP format
            return {
              content: [
                {
                  type: 'text' as const,
                  text: typeof result === 'string' ? result : (JSON.stringify(result, null, 2) ?? ''),
                },
              ],
            }
          } catch (error) {
            // Log detailed error locally
            if (logger) {
              logger.error(`Tool '${tool.name}' execution failed: ${error instanceof Error ? error.stack : String(error)}`)
            }

            // Return tool error result (not JSON-RPC error)
            return {
              content: [
                {
                  type: 'text' as const,
                  text: error instanceof Error ? error.message : String(error),
                },
              ],
              isError: true,
            }
          }
        },
      )

      if (logger) {
        logger.debug(`Registered MCP tool: ${tool.name}`)
      }
    } catch (error) {
      if (logger) {
        logger.error(`Failed to register tool '${tool.name}': ${error instanceof Error ? error.message : String(error)}`)
      }
      throw error
    }
  }

  return server
}

/**
 * Start the MCP server on stdio transport
 *
 * @param server - MCP server instance
 * @param logger - Optional logger instance
 */
export async function startStdioServer(server: McpServer, logger?: Logger): Promise<void> {
  const transport = new StdioServerTransport()
  await server.connect(transport)

  if (logger) {
    logger.info('MCP server running on stdio using official SDK')
  }
}
