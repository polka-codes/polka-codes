// generated by polka.codes
import { afterEach, beforeEach, describe, expect, it } from 'bun:test'
import { mkdirSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { generateSystemPromptWithSkills, initializeSkillContext } from './tool-implementations'

describe('Tool Implementations - Skill Tools', () => {
  const testDir = join(process.cwd(), 'test-skill-tools')
  const skillsDir = join(testDir, '.claude', 'skills')

  beforeEach(() => {
    mkdirSync(skillsDir, { recursive: true })
  })

  afterEach(() => {
    rmSync(testDir, { recursive: true, force: true })
  })

  function createTestSkill(name: string, description: string) {
    const skillDir = join(skillsDir, name)
    mkdirSync(skillDir, { recursive: true })
    const content = `---
name: ${name}
description: ${description}
---

# Test Skill Content
`
    writeFileSync(join(skillDir, 'SKILL.md'), content)
    return skillDir
  }

  describe('generateSystemPromptWithSkills', () => {
    const basePrompt = 'You are a helpful assistant.'

    it('should return base prompt when no skills available', () => {
      const result = generateSystemPromptWithSkills(basePrompt, undefined)
      expect(result).toBe(basePrompt)
    })

    it('should return base prompt when skills context has no skills', () => {
      const result = generateSystemPromptWithSkills(basePrompt, {
        availableSkills: [],
        activeSkill: null,
        skillLoadingHistory: [],
        loadSkill: async () => null,
      })
      expect(result).toBe(basePrompt)
    })

    it('should append skills section to base prompt', async () => {
      createTestSkill('test-skill', 'A test skill')

      const skillContext = await initializeSkillContext(testDir)
      const result = generateSystemPromptWithSkills(basePrompt, skillContext)

      expect(result).toContain(basePrompt)
      expect(result).toContain('## Available Skills')
      expect(result).toContain('test-skill')
    })

    it('should include multiple skills in prompt', async () => {
      createTestSkill('skill-one', 'First skill')
      createTestSkill('skill-two', 'Second skill')

      const skillContext = await initializeSkillContext(testDir)
      const result = generateSystemPromptWithSkills(basePrompt, skillContext)

      expect(result).toContain('skill-one')
      expect(result).toContain('skill-two')
      expect(result).toContain('First skill')
      expect(result).toContain('Second skill')
    })

    it('should preserve base prompt content', async () => {
      const customBasePrompt = 'You are a specialized coding assistant.\n\nYou follow best practices.'

      createTestSkill('test-skill', 'A test skill')

      const skillContext = await initializeSkillContext(testDir)
      const result = generateSystemPromptWithSkills(customBasePrompt, skillContext)

      expect(result).toContain('You are a specialized coding assistant.')
      expect(result).toContain('You follow best practices.')
    })
  })

  describe('initializeSkillContext', () => {
    it('should initialize with discovered skills', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await initializeSkillContext(testDir)

      expect(context.availableSkills).toHaveLength(1)
      expect(context.availableSkills[0].metadata.name).toBe('test-skill')
    })

    it('should initialize with no skills when directory is empty', async () => {
      const context = await initializeSkillContext(testDir)

      expect(context.availableSkills).toHaveLength(0)
    })

    it('should initialize with null active skill', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await initializeSkillContext(testDir)

      expect(context.activeSkill).toBeNull()
    })

    it('should initialize with empty loading history', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await initializeSkillContext(testDir)

      expect(context.skillLoadingHistory).toHaveLength(0)
    })

    it('should use provided cwd parameter', async () => {
      createTestSkill('test-skill', 'A test skill')

      const context = await initializeSkillContext(testDir)

      // Verify skills were discovered from the test directory
      expect(context.availableSkills.length).toBeGreaterThan(0)
    })
  })
})
