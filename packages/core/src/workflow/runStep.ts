// generated by polka.codes
import type { Json, StepRunResult, StepSpecRaw, WorkflowContext } from './types'

export const runStep = async (
  step: StepSpecRaw,
  input: Record<string, Json>,
  context: WorkflowContext,
  resumedState: any | undefined,
  allOutputs: Record<string, Record<string, Json>>,
): Promise<StepRunResult<Record<string, Json>>> => {
  if (context.verbose && context.verbose >= 1) {
    console.log(`[workflow] running step: ${step.id}`)
    console.log(`[workflow] input: ${JSON.stringify(input, null, 2)}`)
  }
  try {
    const validatedInput = step.inputSchema?.parse(input) ?? input

    const result = await step.run({ ...validatedInput, $: allOutputs }, context, resumedState)

    if (context.verbose && context.verbose >= 1) {
      console.log(`[workflow] step result: ${step.id}`, JSON.stringify(result, null, 2))
    }

    if (result.type === 'success') {
      const validatedOutput = step.outputSchema?.parse(result.output) ?? result.output
      return {
        ...result,
        output: validatedOutput,
      }
    }

    return result
  } catch (error) {
    if (context.verbose && context.verbose >= 1) {
      console.error(`[workflow] step error: ${step.id}`, error)
    }
    return { type: 'error', error }
  }
}
