// Generated by polka.codes
// This file implements the AnalyzerAgent class for project analysis

import { getAvailableTools } from '../../getAvailableTools'
import {
  askFollowupQuestion,
  attemptCompletion,
  delegate,
  fetchUrl,
  handOver,
  listFiles,
  readBinaryFile,
  readFile,
  searchFiles,
} from '../../tools'
import { UsageMeter } from '../../UsageMeter'
import { AgentBase, type AgentInfo, type SharedAgentOptions } from '../AgentBase'
import { fullSystemPrompt } from './prompts'

export type AnalyzerAgentOptions = SharedAgentOptions

const agentTools = [askFollowupQuestion, attemptCompletion, delegate, fetchUrl, handOver, listFiles, readBinaryFile, readFile, searchFiles]

export class AnalyzerAgent extends AgentBase {
  constructor(options: AnalyzerAgentOptions) {
    const combinedTools = [...(options.additionalTools ?? []), ...agentTools]
    const tools = getAvailableTools({
      provider: options.provider,
      allTools: combinedTools,
      hasAgent: (options.agents?.length ?? 0) > 0,
      interactive: true,
    })
    const toolNamePrefix = options.toolFormat === 'native' ? '' : 'tool_'
    const systemPrompt = fullSystemPrompt(
      {
        os: options.os,
      },
      tools,
      toolNamePrefix,
      options.customInstructions ?? [],
      options.scripts ?? {},
      options.toolFormat === 'native',
    )

    super(analyzerAgentInfo.name, options.ai, {
      systemPrompt,
      tools,
      toolNamePrefix,
      provider: options.provider,
      interactive: options.interactive,
      agents: options.agents,
      scripts: options.scripts,
      callback: options.callback,
      policies: options.policies,
      toolFormat: options.toolFormat,
      parameters: options.parameters ?? {},
      usageMeter: options.usageMeter ?? new UsageMeter(),
      requestTimeoutSeconds: options.requestTimeoutSeconds,
      requireToolUse: options.requireToolUse ?? true,
    })
  }

  override onBeforeInvokeTool() {
    return Promise.resolve(undefined)
  }
}

export const analyzerAgentInfo = {
  name: 'analyzer',
  responsibilities: [
    'Analyzing project structure and organization',
    'Identifying key source code files and their relationships',
    'Understanding common coding patterns and conventions',
    'Examining development workflow and tooling',
    'Analyzing dependencies and their usage patterns',
  ],
} as const satisfies AgentInfo
