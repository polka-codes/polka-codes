// Tool for flexible file editing with before/after text anchors
// generated by polka.codes

import { type FullToolInfo, PermissionLevel, type ToolHandler, type ToolInfo, ToolResponseType } from '../tool'
import type { FilesystemProvider } from './provider'
import { getArray, getString } from './utils'
import { END_OF_FILE, type EditOperation, START_OF_FILE, editFile } from './utils/editFile'

export const toolInfo = {
  name: 'edit_file',
  description:
    'Request to edit file contents using before/after text anchors with flexible operations. Supports multiple edit operations in a single call.',
  parameters: [
    {
      name: 'path',
      description: 'The path of the file to edit',
      required: true,
      usageValue: 'File path here',
    },
    {
      name: 'operations',
      description: 'Edit operation with start_anchor, end_anchor, new_text, and optional line range hints',
      required: true,
      allowMultiple: true,
      children: [
        {
          name: 'start_anchor',
          description: `Text to find as the start anchor (use ${START_OF_FILE} for file start)`,
          required: false,
          usageValue: 'Text before the edit location',
        },
        {
          name: 'end_anchor',
          description: `Text to find as the end anchor (use ${END_OF_FILE} for file end)`,
          required: false,
          usageValue: 'Text after the edit location',
        },
        {
          name: 'new_text',
          description: 'Text to replace the content between start_anchor and end_anchor',
          required: true,
          usageValue: 'New text content',
        },
        {
          name: 'start_anchor_line_start',
          description: 'Optional line number hint for start_anchor location (1-based)',
          required: false,
          usageValue: '10',
        },
        {
          name: 'end_anchor_line_start',
          description: 'Optional line number hint for end_anchor location (1-based)',
          required: false,
          usageValue: '20',
        },
      ],
      usageValue: 'operations here',
    },
  ],
  examples: [
    {
      description: 'Replace content between two text anchors',
      parameters: [
        {
          name: 'path',
          value: 'src/main.ts',
        },
        {
          name: 'operations',
          value: {
            start_anchor: 'function oldFunction() {',
            end_anchor: '}',
            new_text: '\n  return "new implementation";\n',
          },
        },
      ],
    },
    {
      description: 'Insert at start of file',
      parameters: [
        {
          name: 'path',
          value: 'src/header.ts',
        },
        {
          name: 'operations',
          value: {
            start_anchor: START_OF_FILE,
            end_anchor: 'export',
            new_text: '// File header comment\n',
          },
        },
      ],
    },
    {
      description: 'Multiple operations in one call',
      parameters: [
        {
          name: 'path',
          value: 'src/utils.ts',
        },
        {
          name: 'operations',
          value: [
            {
              start_anchor: 'import React',
              end_anchor: 'from "react"',
              new_text: ', { useState }',
            },
            {
              start_anchor: 'function Component() {',
              end_anchor: 'return (',
              new_text: '\n  const [state, setState] = useState(false);\n  ',
            },
          ],
        },
      ],
    },
  ],
  permissionLevel: PermissionLevel.Write,
} as const satisfies ToolInfo

export const handler: ToolHandler<typeof toolInfo, FilesystemProvider> = async (provider, args) => {
  if (!provider.readFile || !provider.writeFile) {
    return {
      type: ToolResponseType.Error,
      message: 'Not possible to edit file. Abort.',
    }
  }

  const path = getString(args, 'path')
  const operations = getArray(args, 'operations') as unknown as EditOperation[]

  if (!operations || operations.length === 0) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>At least one edit operation is required</error_message></error>`,
    }
  }

  const fileContent = await provider.readFile(path)

  if (fileContent == null) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>File not found</error_message></error>`,
    }
  }

  try {
    const result = await editFile(fileContent, operations)
    await provider.writeFile(path, result)

    return {
      type: ToolResponseType.Reply,
      message: `<edit_file_path>${path}</edit_file_path>`,
    }
  } catch (error) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>${error instanceof Error ? error.message : String(error)}</error_message></error>`,
    }
  }
}

export const isAvailable = (provider: FilesystemProvider): boolean => {
  return !!provider.readFile && !!provider.writeFile
}

export default {
  ...toolInfo,
  handler,
  isAvailable,
} satisfies FullToolInfo
