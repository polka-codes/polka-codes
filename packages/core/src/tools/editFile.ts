// Tool for flexible file editing with search/replace operations
// generated by polka.codes

import { type FullToolInfo, PermissionLevel, type ToolHandler, type ToolInfo, ToolResponseType } from '../tool'
import type { FilesystemProvider } from './provider'
import { getArray, getString } from './utils'
import { END_OF_FILE, type EditOperation, START_OF_FILE, editFile } from './utils/editFile'

export const toolInfo = {
  name: 'edit_file',
  description: 'Request to edit file contents using search/replace operations. Supports multiple edit operations in a single call.',
  parameters: [
    {
      name: 'path',
      description: 'The path of the file to edit',
      required: true,
      usageValue: 'File path here',
    },
    {
      name: 'operations',
      description: 'Edit operation with search and replace parameters',
      required: true,
      allowMultiple: true,
      children: [
        {
          name: 'search',
          description: `Text to search for and replace (use ${START_OF_FILE} to insert at file start, ${END_OF_FILE} to insert at file end)`,
          required: true,
          usageValue: 'Text to find and replace',
        },
        {
          name: 'replace',
          description: 'Text to replace the search text with',
          required: true,
          usageValue: 'Replacement text',
        },
      ],
      usageValue: 'operations here',
    },
  ],
  examples: [
    {
      description: 'Replace specific text',
      parameters: [
        {
          name: 'path',
          value: 'src/main.ts',
        },
        {
          name: 'operations',
          value: {
            search: 'function oldFunction() {\n  return 42;\n}',
            replace: 'function newFunction() {\n  return "new implementation";\n}',
          },
        },
      ],
    },
    {
      description: 'Insert at start of file',
      parameters: [
        {
          name: 'path',
          value: 'src/header.ts',
        },
        {
          name: 'operations',
          value: {
            search: START_OF_FILE,
            replace: '// File header comment\n',
          },
        },
      ],
    },
    {
      description: 'Multiple operations in one call',
      parameters: [
        {
          name: 'path',
          value: 'src/utils.ts',
        },
        {
          name: 'operations',
          value: [
            {
              search: 'import React from "react"',
              replace: 'import React, { useState } from "react"',
            },
            {
              search: 'function Component() {\n  return (',
              replace: 'function Component() {\n  const [state, setState] = useState(false);\n  return (',
            },
          ],
        },
      ],
    },
    {
      description: 'Append content at end of file',
      parameters: [
        {
          name: 'path',
          value: 'src/footer.ts',
        },
        {
          name: 'operations',
          value: {
            search: END_OF_FILE,
            replace: '\n// End of file appended comment\n',
          },
        },
      ],
    },
  ],
  permissionLevel: PermissionLevel.Write,
} as const satisfies ToolInfo

export const handler: ToolHandler<typeof toolInfo, FilesystemProvider> = async (provider, args) => {
  if (!provider.readFile || !provider.writeFile) {
    return {
      type: ToolResponseType.Error,
      message: 'Not possible to edit file. Abort.',
    }
  }

  const path = getString(args, 'path')
  const operations = getArray(args, 'operations') as unknown as EditOperation[]

  if (!operations || operations.length === 0) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>At least one edit operation is required</error_message></error>`,
    }
  }

  const fileContent = await provider.readFile(path)

  if (fileContent == null) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>File not found</error_message></error>`,
    }
  }

  try {
    const result = await editFile(fileContent, operations)
    await provider.writeFile(path, result)

    return {
      type: ToolResponseType.Reply,
      message: `<edit_file_path>${path}</edit_file_path>`,
    }
  } catch (error) {
    return {
      type: ToolResponseType.Error,
      message: `<error><edit_file_path>${path}</edit_file_path><error_message>${error instanceof Error ? error.message : String(error)}</error_message></error>`,
    }
  }
}

export const isAvailable = (provider: FilesystemProvider): boolean => {
  return !!provider.readFile && !!provider.writeFile
}

export default {
  ...toolInfo,
  handler,
  isAvailable,
} satisfies FullToolInfo
