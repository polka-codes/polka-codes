// generated by polka.codes
import { z } from 'zod'
import type { SkillContext } from '../types'
import { validateSkillReferences, validateSkillSecurity } from '../validation'

/**
 * Tool input parameters for loading a skill
 */
export const LoadSkillInputSchema = z.object({
  skillName: z.string().describe('The name of the skill to load'),
})

export type LoadSkillInput = z.infer<typeof LoadSkillInputSchema>

/**
 * Tool output for loading a skill
 */
export const LoadSkillOutputSchema = z.object({
  success: z.boolean(),
  skill: z
    .object({
      name: z.string(),
      description: z.string(),
      content: z.string(),
      availableFiles: z.array(z.string()),
    })
    .optional(),
  error: z.string().optional(),
  warnings: z.array(z.string()).optional(),
})

export type LoadSkillOutput = z.infer<typeof LoadSkillOutputSchema>

/**
 * Load a skill by name to access its instructions and resources
 *
 * This tool enables agents to autonomously load specialized knowledge
 * and capabilities based on task context.
 */
export async function loadSkill(input: LoadSkillInput, context: SkillContext): Promise<LoadSkillOutput> {
  const { skillName } = input

  // Find the skill reference
  const skillRef = context.availableSkills.find((s) => s.metadata.name === skillName)

  if (!skillRef) {
    return {
      success: false,
      error: `Skill '${skillName}' not found`,
    }
  }

  try {
    // Load the full skill
    const skill = await context.loadSkill(skillName)

    if (!skill) {
      return {
        success: false,
        error: `Failed to load skill '${skillName}'`,
      }
    }

    // Validate security
    validateSkillSecurity(skill)

    // Check for reference warnings
    const warnings = validateSkillReferences(skill)

    // Load the skill as active
    context.activeSkill = skill
    context.skillLoadingHistory.push(skillName)

    return {
      success: true,
      skill: {
        name: skill.metadata.name,
        description: skill.metadata.description,
        content: skill.content,
        availableFiles: Array.from(skill.files.keys()),
      },
      warnings: warnings.length > 0 ? warnings : undefined,
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error)
    return {
      success: false,
      error: `Failed to load skill '${skillName}': ${message}`,
    }
  }
}

/**
 * Tool info for loadSkill (used in agent workflow)
 */
export const loadSkillToolInfo = {
  name: 'loadSkill',
  description:
    'Load a skill by name to access its instructions and resources. Use this when you need specialized knowledge or capabilities for a specific task.',
  parameters: LoadSkillInputSchema,
  returns: LoadSkillOutputSchema,
} as const
