// generated by polka.codes
import { z } from 'zod'
import type { SkillContext } from '../types'

/**
 * Tool input parameters for reading a skill file
 */
export const ReadSkillFileInputSchema = z.object({
  skillName: z.string().describe('The name of the skill'),
  filename: z.string().describe('The name of the file to read (e.g., "reference.md", "scripts/helper.py")'),
})

export type ReadSkillFileInput = z.infer<typeof ReadSkillFileInputSchema>

/**
 * Tool output for reading a skill file
 */
export const ReadSkillFileOutputSchema = z.object({
  success: z.boolean(),
  content: z.string().optional(),
  error: z.string().optional(),
})

export type ReadSkillFileOutput = z.infer<typeof ReadSkillFileOutputSchema>

/**
 * Read a supporting file from a loaded skill
 *
 * This tool enables agents to access supporting files bundled with skills,
 * such as reference documentation, examples, scripts, or templates.
 * Files are returned as plain text content.
 */
export async function readSkillFile(input: ReadSkillFileInput, context: SkillContext): Promise<ReadSkillFileOutput> {
  const { skillName, filename } = input

  // Check if active skill matches
  let skill = context.activeSkill && context.activeSkill.metadata.name === skillName ? context.activeSkill : null

  // If not active, try to load it
  if (!skill) {
    try {
      skill = await context.loadSkill(skillName)
    } catch (_error) {
      // Ignore load error, will be handled by null check
    }
  }

  if (!skill) {
    return {
      success: false,
      error: `Skill '${skillName}' not found or could not be loaded. Use loadSkill first.`,
    }
  }

  // Check if file exists in skill
  if (!skill.files.has(filename)) {
    const availableFiles = Array.from(skill.files.keys()).sort()
    return {
      success: false,
      error: `File '${filename}' not found in skill '${skillName}'. Available files: ${availableFiles.join(', ') || 'none'}`,
    }
  }

  // Return file content
  const content = skill.files.get(filename)

  return {
    success: true,
    content,
  }
}

/**
 * Tool info for readSkillFile (used in agent workflow)
 */
export const readSkillFileToolInfo = {
  name: 'readSkillFile',
  description:
    'Read a supporting file from a skill. Use this to access reference documentation, examples, scripts, or templates bundled with a skill. First use loadSkill to see available files, then use this tool to read specific files.',
  parameters: ReadSkillFileInputSchema,
  returns: ReadSkillFileOutputSchema,
} as const
