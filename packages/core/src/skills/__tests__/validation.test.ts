// generated by polka.codes
import { afterEach, beforeEach, describe, expect, it } from 'bun:test'
import { mkdirSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { SkillDiscoveryService } from '../discovery'
import { SkillValidationError } from '../types'
import { validateSkillMetadata, validateSkillReferences, validateSkillSecurity } from '../validation'

describe('Skill Validation', () => {
  const testDir = join(process.cwd(), 'test-skills-validation')
  const skillsDir = join(testDir, 'skills')

  beforeEach(() => {
    mkdirSync(skillsDir, { recursive: true })
  })

  afterEach(() => {
    rmSync(testDir, { recursive: true, force: true })
  })

  function createTestSkill(name: string, content: string) {
    const skillDir = join(skillsDir, name)
    mkdirSync(skillDir, { recursive: true })
    writeFileSync(join(skillDir, 'SKILL.md'), content)
    return skillDir
  }

  describe('validateSkillSecurity', () => {
    it('should accept valid skills within size limits', async () => {
      const content = `---
name: test-skill
description: A test skill
---

${'x'.repeat(1000)}
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      expect(() => validateSkillSecurity(skill)).not.toThrow()
    })

    it('should reject skills with oversized main content', async () => {
      const content = `---
name: test-skill
description: A test skill
---

${'x'.repeat(2 * 1024 * 1024)} // 2MB
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      expect(() => validateSkillSecurity(skill)).toThrow(SkillValidationError)
      expect(() => validateSkillSecurity(skill)).toThrow(/exceeds size limit/)
    })

    it('should reject skills with oversized supporting files', async () => {
      const skillDir = createTestSkill(
        'test',
        `---
name: test-skill
description: A test skill
---
`,
      )

      writeFileSync(join(skillDir, 'large.txt'), 'x'.repeat(2 * 1024 * 1024))

      const service = new SkillDiscoveryService({ cwd: testDir })

      // File size is now checked during loadSkill, not during validation
      await expect(service.loadSkill(join(skillsDir, 'test'), 'project')).rejects.toThrow('File size exceeds limit')
    })

    it('should reject skills with oversized total size', async () => {
      const skillDir = createTestSkill(
        'test',
        `---
name: test-skill
description: A test skill
---

${'x'.repeat(500 * 1024)}
`,
      )

      // Add multiple 900KB files to exceed 10MB total (but each file is under 1MB limit)
      for (let i = 0; i < 11; i++) {
        const fileName = `large${i}.txt`
        writeFileSync(join(skillDir, fileName), 'y'.repeat(900 * 1024))
      }

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      expect(() => validateSkillSecurity(skill)).toThrow(SkillValidationError)
      expect(() => validateSkillSecurity(skill)).toThrow(/total size exceeds limit/)
    })

    it('should detect suspicious script tags', async () => {
      const content = `---
name: test-skill
description: A test skill
---

<script>alert('xss')</script>
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      // First verify the skill has the script tag
      expect(skill.content).toContain('<script>')

      // Now check that validation throws
      expect(() => validateSkillSecurity(skill)).toThrow(SkillValidationError)
    })

    it('should detect javascript: URLs', async () => {
      const content = `---
name: test-skill
description: A test skill
---

Click [here](javascript:alert('xss'))
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      expect(() => validateSkillSecurity(skill)).toThrow(SkillValidationError)
    })

    it('should detect event handlers', async () => {
      const content = `---
name: test-skill
description: A test skill
---

<div onclick="malicious()">
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      expect(() => validateSkillSecurity(skill)).toThrow(SkillValidationError)
    })
  })

  describe('validateSkillReferences', () => {
    it('should warn about external references without disclosure', async () => {
      const content = `---
name: test-skill
description: A test skill
---

See https://example.com for more info.
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const warnings = validateSkillReferences(skill)

      expect(warnings.length).toBeGreaterThan(0)
      expect(warnings.some((w) => w.includes('external references'))).toBe(true)
    })

    it('should not warn about external references if disclosed', async () => {
      const content = `---
name: test-skill
description: A test skill with external documentation and network resources
---

See https://example.com for more info.
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const warnings = validateSkillReferences(skill)

      expect(warnings.some((w) => w.includes('external references'))).toBe(false)
    })

    it('should warn about missing referenced files', async () => {
      const content = `---
name: test-skill
description: A test skill
---

See [reference](reference.md) for details.
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const warnings = validateSkillReferences(skill)

      expect(warnings).toContain('Referenced file not found: reference.md')
    })

    it('should not warn about existing referenced files', async () => {
      const skillDir = createTestSkill(
        'test',
        `---
name: test-skill
description: A test skill
---

See [reference](reference.md) for details.
`,
      )

      writeFileSync(join(skillDir, 'reference.md'), '# Reference')

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const warnings = validateSkillReferences(skill)

      expect(warnings.some((w) => w.includes('reference.md'))).toBe(false)
    })
  })

  describe('validateSkillMetadata', () => {
    it('should accept valid metadata', async () => {
      const content = `---
name: test-skill
description: A meaningful description for testing
---
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const errors = validateSkillMetadata(skill)

      expect(errors).toHaveLength(0)
    })

    it('should reject descriptions that are too short', async () => {
      const content = `---
name: test-skill
description: Too short
---
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const errors = validateSkillMetadata(skill)

      expect(errors.some((e) => e.includes('too short'))).toBe(true)
    })

    it('should accept descriptions that are exactly 20 characters', async () => {
      const content = `---
name: test-skill
description: Exactly 20 chars long!
---
`

      createTestSkill('test', content)

      const service = new SkillDiscoveryService({ cwd: testDir })
      const skill = await service.loadSkill(join(skillsDir, 'test'), 'project')

      const errors = validateSkillMetadata(skill)

      expect(errors.some((e) => e.includes('too short'))).toBe(false)
    })
  })
})
