// generated by polka.codes
import { afterEach, beforeEach, describe, expect, it } from 'bun:test'
import { mkdirSync, rmSync, writeFileSync } from 'node:fs'
import { join } from 'node:path'
import { SkillDiscoveryService } from '../discovery'
import { SkillDiscoveryError } from '../types'

describe('SkillDiscoveryService', () => {
  const testDir = join(process.cwd(), 'test-skills-discovery')
  const personalSkillsDir = join(testDir, 'personal')
  const projectSkillsDir = join(testDir, 'project')

  beforeEach(() => {
    mkdirSync(projectSkillsDir, { recursive: true })
    mkdirSync(personalSkillsDir, { recursive: true })
  })

  afterEach(() => {
    rmSync(testDir, { recursive: true, force: true })
  })

  describe('discoverInDirectory', () => {
    it('should discover skills with valid SKILL.md', async () => {
      const skillDir = join(projectSkillsDir, 'test-skill')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: test-skill
description: A test skill
---

# Test Skill

Instructions here
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(projectSkillsDir, 'project')

      expect(skills).toHaveLength(1)
      expect(skills[0].metadata.name).toBe('test-skill')
      expect(skills[0].content).toContain('Instructions here')
    })

    it('should reject skills with invalid names', async () => {
      const skillDir = join(projectSkillsDir, 'Invalid_Name')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: Invalid_Name
description: Test
---
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(projectSkillsDir, 'project')

      // Should skip invalid skills and log a warning
      expect(skills).toHaveLength(0)
    })

    it('should load additional files', async () => {
      const skillDir = join(projectSkillsDir, 'multi-file-skill')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: multi-file-skill
description: Test
---

See [reference.md](reference.md)
`,
      )

      writeFileSync(join(skillDir, 'reference.md'), '# Reference')

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(projectSkillsDir, 'project')

      expect(skills[0].files.has('reference.md')).toBe(true)
      expect(skills[0].files.get('reference.md')).toContain('# Reference')
    })

    it('should load files in subdirectories', async () => {
      const skillDir = join(projectSkillsDir, 'subdir-skill')
      mkdirSync(skillDir, { recursive: true })

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: subdir-skill
description: Test
---
`,
      )

      mkdirSync(join(skillDir, 'scripts'))
      writeFileSync(join(skillDir, 'scripts', 'helper.sh'), '#!/bin/bash\necho "helper"')

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(projectSkillsDir, 'project')

      expect(skills[0].files.has('scripts/helper.sh')).toBe(true)
    })

    it('should skip directories without SKILL.md', async () => {
      mkdirSync(join(projectSkillsDir, 'not-a-skill'))
      writeFileSync(join(projectSkillsDir, 'not-a-skill', 'README.md'), '# README')

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(projectSkillsDir, 'project')

      expect(skills).toHaveLength(0)
    })

    it('should handle directories that do not exist', async () => {
      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverInDirectory(join(testDir, 'nonexistent'), 'project')

      expect(skills).toHaveLength(0)
    })
  })

  describe('discoverAll', () => {
    it('should load skills from both project and personal directories', async () => {
      // Create project skill in correct location
      const actualProjectSkillsDir = join(testDir, '.claude', 'skills')
      const projectSkillDir = join(actualProjectSkillsDir, 'project-skill')
      mkdirSync(projectSkillDir, { recursive: true })
      writeFileSync(
        join(projectSkillDir, 'SKILL.md'),
        `---
name: project-skill
description: Project skill
---
`,
      )

      // Create personal skill
      const personalSkillDir = join(personalSkillsDir, 'personal-skill')
      mkdirSync(personalSkillDir)
      writeFileSync(
        join(personalSkillDir, 'SKILL.md'),
        `---
name: personal-skill
description: Personal skill
---
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverAll()

      expect(skills).toHaveLength(2)
      expect(skills.some((s) => s.metadata.name === 'project-skill')).toBe(true)
      expect(skills.some((s) => s.metadata.name === 'personal-skill')).toBe(true)
    })

    it('should handle duplicate skill names (project takes priority)', async () => {
      // Create project skill in correct location
      const actualProjectSkillsDir = join(testDir, '.claude', 'skills')
      const projectSkillDir = join(actualProjectSkillsDir, 'my-skill')
      mkdirSync(projectSkillDir, { recursive: true })
      writeFileSync(
        join(projectSkillDir, 'SKILL.md'),
        `---
name: my-skill
description: Project version
---
`,
      )

      // Create personal skill with same name
      const personalSkillDir = join(personalSkillsDir, 'my-skill')
      mkdirSync(personalSkillDir)
      writeFileSync(
        join(personalSkillDir, 'SKILL.md'),
        `---
name: my-skill
description: Personal version
---
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skills = await service.discoverAll()

      expect(skills).toHaveLength(1)
      expect(skills[0].metadata.name).toBe('my-skill')
      expect(skills[0].source).toBe('project')
      expect(skills[0].metadata.description).toBe('Project version')
    })
  })

  describe('loadSkill', () => {
    it('should load skill metadata and content separately', async () => {
      const skillDir = join(projectSkillsDir, 'test-skill')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: test-skill
description: Test skill description
---

# Test Skill

This is the content.
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const skill = await service.loadSkill(skillDir, 'project')

      expect(skill.metadata.name).toBe('test-skill')
      expect(skill.metadata.description).toBe('Test skill description')
      expect(skill.content).toContain('# Test Skill')
      expect(skill.content).toContain('This is the content.')
      expect(skill.content).not.toContain('name: test-skill')
    })

    it('should throw error if SKILL.md does not exist', async () => {
      const skillDir = join(projectSkillsDir, 'no-skill-md')
      mkdirSync(skillDir)

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })

      expect(service.loadSkill(skillDir, 'project')).rejects.toThrow(SkillDiscoveryError)
    })

    it('should throw error if frontmatter is invalid', async () => {
      const skillDir = join(projectSkillsDir, 'invalid-frontmatter')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: Invalid@Name
description: Test
---
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })

      expect(service.loadSkill(skillDir, 'project')).rejects.toThrow()
    })

    it('should throw error if frontmatter is missing', async () => {
      const skillDir = join(projectSkillsDir, 'no-frontmatter')
      mkdirSync(skillDir)

      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `# Just markdown
No frontmatter here.
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })

      expect(service.loadSkill(skillDir, 'project')).rejects.toThrow(SkillDiscoveryError)
    })
  })

  describe('createContext', () => {
    it('should create initial skill context with available skills', async () => {
      // Create skill in the correct location for the service to find it
      const actualProjectSkillsDir = join(testDir, '.claude', 'skills')
      const skillDir = join(actualProjectSkillsDir, 'test-skill')
      mkdirSync(skillDir, { recursive: true })
      writeFileSync(
        join(skillDir, 'SKILL.md'),
        `---
name: test-skill
description: Test
---
`,
      )

      const service = new SkillDiscoveryService({
        cwd: testDir,
        personalSkillsDir,
      })
      const context = await service.createContext()

      expect(context.activeSkill).toBeNull()
      expect(context.availableSkills).toHaveLength(1)
      expect(context.skillLoadingHistory).toHaveLength(0)
    })
  })
})
